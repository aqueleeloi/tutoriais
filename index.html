<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>adminHUB | Portal</title>
    
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <script>
        !function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.async=!0,p.src=s.api_host+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="capture identify alias people.set people.set_once set_config register register_once unregister opt_out_capturing has_opted_out_capturing opt_in_capturing reset isFeatureEnabled onFeatureFlags getFeatureFlag getFeatureFlagPayload reloadFeatureFlags group updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures getActiveMatchingSurveys getSurveys getNextSurveyStep onSessionId".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
        
        posthog.init('phc_9xPN0iLCE7yTiZleow1k93LPp2GIPDubHR92KDhmMoD', { api_host: 'https://us.i.posthog.com' });
    </script>

    <style>
        body { background: #050505; color: white; font-family: 'Segoe UI', sans-serif; display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; }
        .hidden { display: none !important; }

        .container { display: flex; gap: 40px; align-items: stretch; flex-wrap: wrap; justify-content: center; padding: 20px; }
        
        .card { 
            background: #111; border: 1px solid #222; padding: 40px; border-radius: 24px; 
            text-align: center; width: 320px; box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            display: flex; flex-direction: column; justify-content: center; transition: transform 0.2s;
        }
        .card:hover { border-color: #333; }

        .brand { font-size: 2rem; font-weight: 800; margin-bottom: 5px; letter-spacing: -1px; }
        .brand span { color: #00C6FF; }

        /* Estilo Input IEFP */
        .iefp-input {
            width: 100%; background: #1a1a1a; border: 1px solid #333; color: white;
            padding: 12px; border-radius: 8px; margin-bottom: 10px; outline: none;
            text-align: center;
        }
        .iefp-input:focus { border-color: #00C6FF; background: #000; }
        
        .iefp-btn {
            width: 100%; background: #00C6FF; color: #000; border: none;
            padding: 12px; border-radius: 8px; font-weight: 800; cursor: pointer;
            transition: 0.2s; text-transform: uppercase;
        }
        .iefp-btn:hover { background: #fff; transform: scale(1.02); }

        /* Perfil */
        .user-img { width: 90px; height: 90px; border-radius: 50%; border: 3px solid #333; margin-bottom: 15px; }
        .badge { padding: 6px 12px; border-radius: 50px; font-size: 0.7rem; font-weight: bold; text-transform: uppercase; display: inline-block; margin-bottom: 20px; }
        .badge.user { background: #333; color: #888; border: 1px solid #555; }
        
        .btn-enter { width: 100%; padding: 16px; border-radius: 12px; border: none; cursor: pointer; font-weight: 700; margin-top: 10px; text-transform: uppercase; }
        .btn-enter.user { background: #fff; color: #000; }
        .btn-enter.user:hover { background: #ddd; }

        @media (max-width: 700px) { .container { flex-direction: column; align-items: center; } }
    </style>
</head>
<body>

    <div id="login-view" class="container">
        
        <div class="card">
            <div class="brand">admin<span>HUB.</span></div>
            <p style="color:#666; font-size:0.85rem; margin-bottom: 20px;">Conta Google / Gmail</p>
            
            <div id="googleBtn" style="display:flex; justify-content:center;"></div>
            
            <p style="font-size:0.7rem; color:#444; margin-top:20px;">
                Recomendado para uso pessoal
            </p>
        </div>

        <div class="card" style="border-top: 3px solid #00C6FF;">
            <h3 style="margin-bottom: 5px; color:#fff"><i class="fas fa-building"></i> Conta IEFP</h3>
            <p style="color:#666; font-size:0.85rem; margin-bottom: 20px;">Acesso Institucional</p>

            <input type="email" id="emailInput" class="iefp-input" placeholder="seu.nome@formacao.iefp.pt">
            <button onclick="loginDireto()" class="iefp-btn">Entrar</button>

            <p style="font-size:0.7rem; color:#444; margin-top:15px;">
                Entrada direta sem verificação Google
            </p>
        </div>

    </div>

    <div id="profile-view" class="card hidden" style="width: 380px;">
        <img id="p-img" class="user-img" src="">
        <h2 id="p-name" style="margin: 0; font-size: 1.4rem;"></h2>
        <div id="p-email" style="color: #666; font-size: 0.9rem; margin-bottom: 15px;"></div>
        <div id="p-badge" class="badge"></div>
        
        <div id="actions">
            <button class="btn-enter user" onclick="entrar('app.html')">Aceder aos Conteúdos</button>
        </div>

        <div onclick="logout()" style="margin-top:20px; color:#666; cursor:pointer; font-size:0.8rem;">Sair</div>
    </div>

    <script>
        const GOOGLE_ID = "996132120935-0v98fg6n86hfjsk4p55qop3jld4sruos.apps.googleusercontent.com"; 

        // 1. GOOGLE
        function handleGoogleLogin(response) {
            const data = jwtDecode(response.credential);
            processarLogin(data.name, data.email, data.picture);
        }

        // 2. IEFP
        function loginDireto() {
            const email = document.getElementById('emailInput').value.trim().toLowerCase();
            if (!email.endsWith("@formacao.iefp.pt")) {
                alert("⚠️ Apenas para emails @formacao.iefp.pt");
                return;
            }
            const nome = email.split('@')[0];
            const foto = "https://ui-avatars.com/api/?name=" + nome + "&background=00C6FF&color=fff&size=128";
            processarLogin(nome, email, foto);
        }

        // 3. PROCESSAR (AGORA TODOS SÃO ALUNOS)
        function processarLogin(nome, email, foto) {
            
            // Guardamos sempre como "aluno", ignorando quem é
            const userData = { name: nome, email: email, picture: foto };
            sessionStorage.setItem("hub_user", JSON.stringify(userData));
            sessionStorage.setItem("hub_role", "aluno"); // <--- AQUI: Todos são alunos

            posthog.identify(email, { name: nome, email: email, role: "aluno" });

            // Mostrar Ecrã de Boas-vindas
            document.getElementById('login-view').classList.add('hidden');
            document.getElementById('profile-view').classList.remove('hidden');
            
            document.getElementById('p-img').src = foto;
            document.getElementById('p-name').innerText = nome;
            document.getElementById('p-email').innerText = email;
            
            const badge = document.getElementById('p-badge');
            badge.innerText = "ALUNO / VISITANTE";
            badge.className = "badge user";
        }

        function entrar(url) { window.location.href = url; }
        function logout() { sessionStorage.clear(); location.reload(); }

        window.onload = function() {
            google.accounts.id.initialize({ client_id: GOOGLE_ID, callback: handleGoogleLogin });
            google.accounts.id.renderButton(document.getElementById("googleBtn"), { theme: "outline", size: "large" });
        }

        function jwtDecode(token) {
            var base64Url = token.split('.')[1];
            var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        }
    </script>
</body>
</html>
